<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ‰‹ç¯å†¥æƒ³åº”ç”¨</title>
    
    <!-- PWA ç›¸å…³æ ‡ç­¾ -->
    <meta name="theme-color" content="#4a90e2" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    <!-- Manifest é“¾æ¥ -->
    <link rel="manifest" href="public/manifest.json" />
    
    <!-- å›¾æ ‡é“¾æ¥ -->
    <link rel="icon" type="image/svg+xml" href="public/icons/icon.svg" />
    <link rel="apple-touch-icon" href="public/icons/icon-192x192.png" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        .meditation-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
            cursor: grab;
            user-select: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .meditation-container:active {
            cursor: grabbing;
        }

        /* è§†é¢‘èƒŒæ™¯æ ·å¼ */
        .video-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .background-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            transition: opacity 0.3s ease-in-out;
        }

        /* è§†é¢‘æŒ‡ç¤ºå™¨ */
        .video-indicators {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .indicator.active {
            background-color: #ffffff;
            transform: scale(1.2);
        }

        /* è§†é¢‘åç§° */
        .video-name {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            color: #ffffff;
            font-size: 16px;
            font-weight: 500;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 5px 15px;
            border-radius: 20px;
        }

        /* å†…å®¹è¦†ç›–å±‚ */
        .content-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 5;
            background: linear-gradient(
                to bottom,
                rgba(0, 0, 0, 0.1) 0%,
                rgba(0, 0, 0, 0.3) 100%
            );
        }

        /* PWA çŠ¶æ€ */
        .pwa-status {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        .offline-indicator {
            background-color: rgba(255, 152, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .install-button {
            background-color: rgba(76, 175, 80, 0.9);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .install-button:hover {
            background-color: rgba(76, 175, 80, 1);
            transform: translateY(-2px);
        }

        /* è®¡æ—¶å™¨æ˜¾ç¤º */
        .timer-display {
            text-align: center;
            margin-bottom: 40px;
        }

        .timer-display h1 {
            font-size: 72px;
            font-weight: 200;
            color: #ffffff;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            letter-spacing: 2px;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .timer-controls {
            margin-bottom: 40px;
        }

        .play-pause-button {
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            border: none;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .play-pause-button:hover {
            background-color: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
        }

        /* è§†é¢‘å ä½ç¬¦æ ·å¼ */
        .video-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            text-align: center;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .timer-display h1 {
                font-size: 56px;
            }

            .play-pause-button {
                padding: 16px 32px;
                font-size: 16px;
            }

            .video-name {
                font-size: 14px;
                padding: 4px 12px;
            }

            .pwa-status {
                top: 10px;
                right: 10px;
            }
        }

        @media (max-height: 600px) {
            .timer-display h1 {
                font-size: 48px;
            }

            .timer-display {
                margin-bottom: 30px;
            }

            .timer-controls {
                margin-bottom: 30px;
            }

            .play-pause-button {
                padding: 14px 28px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="meditation-container">
            <!-- è§†é¢‘èƒŒæ™¯ -->
            <div class="video-background">
                <div id="videoContainer" class="video-placeholder">
                    <div>
                        <div>ğŸŒ² æ£®æ—èƒŒæ™¯è§†é¢‘ ğŸŒ²</div>
                        <div style="margin-top: 20px; font-size: 16px;">è¯·å°†è§†é¢‘æ–‡ä»¶æ·»åŠ åˆ° /public/videos/ ç›®å½•</div>
                        <div style="margin-top: 10px; font-size: 14px;">æ–‡ä»¶åï¼šforest-background.mp4, candlelight-background.mp4</div>
                    </div>
                </div>
                
                <!-- è§†é¢‘åˆ‡æ¢æŒ‡ç¤ºå™¨ -->
                <div class="video-indicators">
                    <div class="indicator active" data-index="0"></div>
                    <div class="indicator" data-index="1"></div>
                </div>
                
                <!-- å½“å‰è§†é¢‘åç§° -->
                <div class="video-name" id="videoName">æ£®æ—èƒŒæ™¯</div>
            </div>
            
            <!-- å†…å®¹è¦†ç›–å±‚ -->
            <div class="content-overlay">
                <!-- PWA çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div class="pwa-status">
                    <div id="offlineIndicator" class="offline-indicator" style="display: none;">
                        ğŸ“± ç¦»çº¿æ¨¡å¼
                    </div>
                    <button id="installButton" class="install-button" style="display: none;">
                        ğŸ“± å®‰è£…åº”ç”¨
                    </button>
                </div>
                
                <div class="timer-display">
                    <h1 id="timerDisplay">10:00</h1>
                </div>
                
                <div class="timer-controls">
                    <button id="playPauseButton" class="play-pause-button">å¼€å§‹</button>
                </div>
            </div>
            
            <!-- éŸ³é¢‘å…ƒç´  -->
            <audio id="meditationAudio" preload="auto" loop>
                <source src="music/meditation-background-434654.mp3" type="audio/mpeg">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
            </audio>
        </div>
    </div>

    <script>
        // åº”ç”¨çŠ¶æ€
        let isPlaying = false;
        let timeLeft = 10 * 60; // 10åˆ†é’Ÿ
        let currentVideoIndex = 0;
        let isTransitioning = false;
        let touchStartX = 0;
        let touchEndX = 0;
        
        // è§†é¢‘æ–‡ä»¶åˆ—è¡¨
        const videos = [
            { name: 'æ£®æ—èƒŒæ™¯', file: 'forest-background.mp4' },
            { name: 'çƒ›å…‰èƒŒæ™¯', file: 'candlelight-background.mp4' }
        ];
        
        // DOM å…ƒç´ 
        const timerDisplay = document.getElementById('timerDisplay');
        const playPauseButton = document.getElementById('playPauseButton');
        const meditationAudio = document.getElementById('meditationAudio');
        const videoContainer = document.getElementById('videoContainer');
        const videoName = document.getElementById('videoName');
        const indicators = document.querySelectorAll('.indicator');
        const offlineIndicator = document.getElementById('offlineIndicator');
        const installButton = document.getElementById('installButton');
        
        // è®¾ç½®éŸ³é¢‘éŸ³é‡
        meditationAudio.volume = 0.3;
        
        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
        function updateTimerDisplay() {
            timerDisplay.textContent = formatTime(timeLeft);
        }
        
        // å¤„ç†æ’­æ”¾/æš‚åœ
        function handlePlayPause() {
            isPlaying = !isPlaying;
            
            if (isPlaying) {
                playPauseButton.textContent = 'æš‚åœ';
                meditationAudio.play().catch(error => {
                    console.warn('æ— æ³•è‡ªåŠ¨æ’­æ”¾éŸ³ä¹:', error);
                });
                startTimer();
            } else {
                playPauseButton.textContent = 'å¼€å§‹';
                meditationAudio.pause();
                stopTimer();
            }
        }
        
        // è®¡æ—¶å™¨ç›¸å…³
        let timerInterval = null;
        
        function startTimer() {
            if (timerInterval) return;
            
            timerInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    updateTimerDisplay();
                } else {
                    // è®¡æ—¶ç»“æŸ
                    isPlaying = false;
                    playPauseButton.textContent = 'å¼€å§‹';
                    meditationAudio.pause();
                    stopTimer();
                    
                    // å‘é€é€šçŸ¥
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('å†¥æƒ³æ—¶é—´ç»“æŸ', {
                            body: 'æ‚¨çš„å†¥æƒ³æ—¶é—´å·²ç»ç»“æŸï¼Œå¸Œæœ›æ‚¨æ„Ÿåˆ°æ”¾æ¾å’Œæ„‰æ‚¦ï¼',
                            icon: 'icons/icon-192x192.png',
                            badge: 'icons/icon-96x96.png',
                            vibrate: [200, 100, 200]
                        });
                    }
                }
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        // åˆ‡æ¢è§†é¢‘èƒŒæ™¯
        function switchVideo(direction) {
            if (isTransitioning) return;
            
            isTransitioning = true;
            
            setTimeout(() => {
                if (direction === 'next') {
                    currentVideoIndex = (currentVideoIndex + 1) % videos.length;
                } else {
                    currentVideoIndex = (currentVideoIndex - 1 + videos.length) % videos.length;
                }
                
                updateVideoDisplay();
                isTransitioning = false;
            }, 300);
        }
        
        // æ›´æ–°è§†é¢‘æ˜¾ç¤º
        function updateVideoDisplay() {
            const video = videos[currentVideoIndex];
            videoName.textContent = video.name;
            
            // æ›´æ–°æŒ‡ç¤ºå™¨
            indicators.forEach((indicator, index) => {
                if (index === currentVideoIndex) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });
            
            // å°è¯•åŠ è½½è§†é¢‘æ–‡ä»¶
            const videoElement = document.createElement('video');
            videoElement.src = `videos/${video.file}`;
            videoElement.autoplay = true;
            videoElement.muted = true;
            videoElement.loop = true;
            videoElement.playsInline = true;
            videoElement.className = 'background-video';
            
            videoElement.onloadeddata = () => {
                videoContainer.innerHTML = '';
                videoContainer.appendChild(videoElement);
            };
            
            videoElement.onerror = () => {
                // è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºå ä½ç¬¦
                videoContainer.innerHTML = `
                    <div class="video-placeholder">
                        <div>
                            <div>${video.name === 'æ£®æ—èƒŒæ™¯' ? 'ğŸŒ²' : 'ğŸ•¯ï¸'} ${video.name} ğŸŒ²</div>
                            <div style="margin-top: 20px; font-size: 16px;">è§†é¢‘æ–‡ä»¶æœªæ‰¾åˆ°</div>
                            <div style="margin-top: 10px; font-size: 14px;">è¯·æ·»åŠ  ${video.file} åˆ° /public/videos/ ç›®å½•</div>
                        </div>
                    </div>
                `;
            };
        }
        
        // è§¦æ‘¸äº‹ä»¶å¤„ç†
        function handleTouchStart(e) {
            touchStartX = e.targetTouches[0].clientX;
        }
        
        function handleTouchMove(e) {
            touchEndX = e.targetTouches[0].clientX;
        }
        
        function handleTouchEnd() {
            const touchDiff = touchStartX - touchEndX;
            const minSwipeDistance = 50;
            
            if (Math.abs(touchDiff) > minSwipeDistance) {
                if (touchDiff > 0) {
                    // å‘å·¦æ»‘åŠ¨ - ä¸‹ä¸€ä¸ªè§†é¢‘
                    switchVideo('next');
                } else {
                    // å‘å³æ»‘åŠ¨ - ä¸Šä¸€ä¸ªè§†é¢‘
                    switchVideo('prev');
                }
            }
        }
        
        // é¼ æ ‡äº‹ä»¶å¤„ç†ï¼ˆæ¡Œé¢ç«¯æµ‹è¯•ï¼‰
        function handleMouseDown(e) {
            touchStartX = e.clientX;
        }
        
        function handleMouseMove(e) {
            if (e.buttons === 1) { // é¼ æ ‡å·¦é”®æŒ‰ä¸‹
                touchEndX = e.clientX;
            }
        }
        
        function handleMouseUp() {
            const touchDiff = touchStartX - touchEndX;
            const minSwipeDistance = 50;
            
            if (Math.abs(touchDiff) > minSwipeDistance) {
                if (touchDiff > 0) {
                    switchVideo('next');
                } else {
                    switchVideo('prev');
                }
            }
        }
        
        // æŒ‡ç¤ºå™¨ç‚¹å‡»äº‹ä»¶
        function handleIndicatorClick(e) {
            const index = parseInt(e.target.dataset.index);
            if (index !== currentVideoIndex && !isTransitioning) {
                isTransitioning = true;
                
                setTimeout(() => {
                    currentVideoIndex = index;
                    updateVideoDisplay();
                    isTransitioning = false;
                }, 300);
            }
        }
        
        // ç½‘ç»œçŠ¶æ€ç›‘å¬
        function updateOnlineStatus() {
            if (navigator.onLine) {
                offlineIndicator.style.display = 'none';
            } else {
                offlineIndicator.style.display = 'block';
            }
        }
        
        // PWA å®‰è£…å¤„ç†
        let deferredPrompt = null;
        
        function handleInstallClick() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('ç”¨æˆ·æ¥å—äº† PWA å®‰è£…');
                    } else {
                        console.log('ç”¨æˆ·æ‹’ç»äº† PWA å®‰è£…');
                    }
                    deferredPrompt = null;
                    installButton.style.display = 'none';
                });
            }
        }
        
        // åˆå§‹åŒ–
        function init() {
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            playPauseButton.addEventListener('click', handlePlayPause);
            
            // æ»‘åŠ¨æ‰‹åŠ¿
            document.addEventListener('touchstart', handleTouchStart);
            document.addEventListener('touchmove', handleTouchMove);
            document.addEventListener('touchend', handleTouchEnd);
            
            // é¼ æ ‡æ‰‹åŠ¿ï¼ˆæ¡Œé¢ç«¯ï¼‰
            document.addEventListener('mousedown', handleMouseDown);
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
            
            // æŒ‡ç¤ºå™¨ç‚¹å‡»
            indicators.forEach(indicator => {
                indicator.addEventListener('click', handleIndicatorClick);
            });
            
            // ç½‘ç»œçŠ¶æ€
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
            
            // PWA å®‰è£…äº‹ä»¶å¤„ç†
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installButton.style.display = 'block';
            });
            
            installButton.addEventListener('click', handleInstallClick);
            
            // è¯·æ±‚é€šçŸ¥æƒé™
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('é€šçŸ¥æƒé™å·²æˆäºˆ');
                    }
                });
            }
            
            // åˆå§‹åŒ–æ˜¾ç¤º
            updateTimerDisplay();
            updateVideoDisplay();
            
            // æ³¨å†Œ Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker æ³¨å†Œå¤±è´¥:', error);
                    });
            }
        }
        
        // å¯åŠ¨åº”ç”¨
        init();
    </script>
</body>
</html>